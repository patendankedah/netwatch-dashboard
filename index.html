<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>BACOK WIFI - TV MODE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: #000;
  color: #fff;
  overflow: hidden;
}

.container {
  padding: 20px;
}

h1 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 34px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th {
  background: #222;
  padding: 14px;
  text-align: left;
  font-size: 20px;
  position: sticky;
  top: 0;
  z-index: 10;
}

td {
  padding: 14px;
  font-size: 20px;
  border-bottom: 1px solid #333;
}

.status {
  text-align: center;
}

/* status dot */
.dot {
  display: inline-block;
  width: 22px;
  height: 22px;
  border-radius: 50%;
}

.dot.up {
  background: #00ff00;
}

.dot.down {
  background: #ff3333;
  animation: blink 1s infinite;
}

/* highlight row */
tr.down-row {
  background: #3a0000;
}

tr.parent-down {
  background: #332800;
}

@keyframes blink {
  50% { opacity: 0.4; }
}

.footer {
  text-align: center;
  margin-top: 15px;
  color: #aaa;
  font-size: 14px;
}
</style>
</head>

<body>
<div class="container">
  <h1>ðŸ“¡ BACOK WIFI â€“ MONITORING</h1>

  <table>
    <thead>
      <tr>
        <th>Node</th>
        <th>Status</th>
        <th>Update</th>
      </tr>
    </thead>
    <tbody id="statusBody">
      <tr><td colspan="3">Loading...</td></tr>
    </tbody>
  </table>

  <div class="footer">
    Auto refresh 10 detik â€¢ TV Mode â€¢ Double click = Fullscreen
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwhIhaKNpLZTbDYA0CkniiPjnHbJwPAu3W2q7DrxlOV7MvRIRNPD-HjbV8McSTxIC9v/exec";

let downParents = new Set();

/* format waktu tanpa detik */
function formatTime(iso) {
  if (!iso) return "-";
  const d = new Date(iso);
  return d.toLocaleString("id-ID", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit"
  });
}

async function loadData() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    renderTree(data);
  } catch (e) {
    document.getElementById("statusBody").innerHTML =
      "<tr><td colspan='3' style='color:red'>Gagal ambil data</td></tr>";
  }
}

function renderTree(data) {
  const tbody = document.getElementById("statusBody");
  tbody.innerHTML = "";
  downParents.clear();

  const nodes = {};

  /* build node map (case-insensitive) */
  data.forEach(d => {
    const key = d.comment.trim().toLowerCase();
    nodes[key] = {
      key,
      name: d.comment.trim(),
      parent: (d.parent || "-").trim().toLowerCase(),
      status: d.status,
      time: d.updated_at,
      children: []
    };
  });

  /* build hierarchy + detect DOWN parent */
  Object.values(nodes).forEach(n => {
    if (n.parent !== "-" && nodes[n.parent]) {
      nodes[n.parent].children.push(n);
      if (n.status === "down") {
        downParents.add(n.parent);
      }
    }
  });

  /* render root */
  Object.values(nodes)
    .filter(n => n.parent === "-")
    .forEach(n => drawNode(n, 0, tbody));
}

function drawNode(node, level, tbody) {
  const tr = document.createElement("tr");

  if (node.status === "down") tr.classList.add("down-row");
  if (downParents.has(node.key)) tr.classList.add("parent-down");

  tr.innerHTML = `
    <td style="padding-left:${level * 30}px">${node.name}</td>
    <td class="status">
      <span class="dot ${node.status === "up" ? "up" : "down"}"></span>
    </td>
    <td>${formatTime(node.time)}</td>
  `;

  tbody.appendChild(tr);

  node.children.forEach(c => drawNode(c, level + 1, tbody));
}

/* auto refresh */
loadData();
setInterval(loadData, 10000);

/* fullscreen */
document.addEventListener("dblclick", () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  }
});

/* auto scroll TV */
let direction = 1;
setInterval(() => {
  window.scrollBy(0, direction);
  if ((window.innerHeight + window.scrollY) >= document.body.scrollHeight - 5) {
    direction = -1;
  }
  if (window.scrollY <= 0) {
    direction = 1;
  }
}, 40);
</script>
</body>
</html>
